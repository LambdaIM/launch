# 配置 storagenode 

## 1. 配置
### 初始化

如果创建存储节点已初始化，请忽略此步骤

```
./storagenode init 
```

### 生成密钥
请保持这个安全性
```
./storagenode keygen
```
### 修改配置文件
初始化storagenode后，默认生成配置文件~/.lamborage/config/node.toml，修改node.toml


```

[server]
# 服务启动绑定的地址
# 针对公网ip有限的情况，这里可以用内网地址，然后做端口转发接收目标地址是kad.external_address的请求
address = "1.2.3.4:13002"  

[kad]
# lambda 网络提供的DHT 种子节点地址
bootstrap_addr = "39.105.148.217:13000"  ## 可选dht地址：39.105.148.217:13000/47.94.129.97:13000/47.93.196.236:13000
# 节点注册到DHT网络的地址，这个必须是公网地址, 接收到的请求是由 绑定在server.address的服务处理的
external_address = "5.6.7.8:13000"

[gateway]
# 存储gateway服务启动绑定的地址, ./storagenode gateway 启动使用这个地址
# 针对公网ip有限的情况，这里可以用内网地址，然后做端口转发接收目标地址是gateway.external_address的请求
address = "0.0.0.0:9000"
# 存储节点对外声称的地址，这个必须是公网地址，接收到的请求是由 绑定在gateway.address的服务处理的
external_address = "5.6.7.8:9000" 
# gateway 配置文件目录
conf_dir = "/root/.lamborage/gateway"
# 数据存储目录
data_dir = "/root/.lamborage/store"
#挖矿数据存储目录
mining_dir = "/root/.lamborage/store/mining"

[message]
# storage_name为矿机名称machine-name；
storage_name = "machine-name" 
# MINER REST address
# miner节点启动的rest服务, 内网地址
miner_address = "5.6.7.8:26670" 
```

## 2. 启动storagenode

启动storagenode server和启动gateway server。
```
nohup ./storagenode server >> sserver.out 2>&1 &
nohup ./storagenode gateway >> sgateway.out 2>&1 &
```


# 挖矿

## 1. 配置

初始化lamb
```
./lamb init
```
初始化lamb 后会默认生成配置文件~/.lamborage/config/user.toml，修改user.toml

```
[broker]
# dht_gateway_addr为验证节点的dht服务 IP和端口；
dht_gateway_addr = "39.105.148.217:13000"  ## 可选dht地址：39.105.148.217:13000/47.94.129.97:13000/47.93.196.236:13000
# validator_addr为验证节点IP和端口
validator_addr = "39.105.148.217:13659"   ## 可选地址：39.105.148.217:13659/47.94.129.97:13659/47.93.196.236:13659
extra_key_file = " "

[gateway]
# local listen address
address = "0.0.0.0:9002"
# for login web UI
access_key = "accesskey"
secret_key = "secretkey"
```
同步所有订单的token

account-name 为发起买单账户名称
```
./lamb token sync [account-name]
```


## 2. 上传、查询文件

文本/图片/视频/音频/可执行文件/压缩包文件可正常上传。上传源文件路径为绝对路径。

- orderId为匹配单orderID;
- account-name为发起买单账户名称；

- 用内网上传文件使用下面两个参数：
- - provider_storage_address为配置文件~/.lamborage/config/node.toml里的gateway.address
- - provider_node_address为配置文件~/.lamborage/config/node.toml里的server.address


上传文件

```
LAMBDA_ORDER_ID=[orderId]./lamb cp [account-name] [srcPath] lamb:// --provider_node_address 1.2.3.4:13000 --provider_storage_address 1.2.3.4:9000
```
查询文件列表

```
LAMBDA_ORDER_ID=[orderId] ./lamb ls [account-name] lamb://
```


## 3. 矿工挖矿

矿工每存储文件1G文件会对应生成一个声明，所有声明有效期为1个月，每个出块周期（大约每6s出一个块）会由共识网络发起挑战，挑战声明成功并提交挖矿证明的矿工就会得到一笔收益。


1. 有效订单且有效存储文件 >= (1T) 的矿工有挖矿权利；
2. 矿工已存文件分别为1/3/5G可生成对应1/3/5个声明；
3. 单个矿工声明越多，声明被挑选到的概率越大。


## 4. 挖矿收益
矿工收益 = 单个区块增发量 * （43% * 95% / 挖矿的矿工数量） + 单个区块增发量 * （43% * 5% / 挖矿的矿工数量 ）* 矿工质押量在节点质押量的占比 * 75%

```
比如单个区块增发量为100LAMB，全网共1个节点该节点质押666TBB，全网共10个矿工分别质押1TBB且分别有10个声明。
则单个矿工单个区块得到的挖矿奖励为4.085LAMB= 100LAMB * 43% * 95% / 10 + 100LAMB * 43% * 5% / 10 * 1/676 * 75%
```

