# 配置 storagenode 

## 1. 配置
### 初始化
```
./storagenode init 
```

### 生成密钥
请保持这个安全性
```
./storagenode keygen
```
### 修改配置文件
初始化storagenode后，默认生成配置文件~/.lamborage/config/node.toml，修改node.toml


```

[server]
# 服务启动绑定的地址
# 针对公网ip有限的情况，这里可以用内网地址，然后做端口转发接收目标地址是kad.external_address的请求
address = "1.2.3.4:13002"  

[kad]
# lambda 网络提供的DHT 种子节点地址
bootstrap_addr = "1.2.3.4:12000"
# 节点注册到DHT网络的地址，这个必须是公网地址, 接收到的请求是由 绑定在server.address的服务处理的
external_address = "5.6.7.8:13000"

[gateway]
# 存储gateway服务启动绑定的地址, ./storagenode gateway 启动使用这个地址
# 针对公网ip有限的情况，这里可以用内网地址，然后做端口转发接收目标地址是gateway.external_address的请求
address = "0.0.0.0:9000"
# 存储节点对外声称的地址，这个必须是公网地址，接收到的请求是由 绑定在gateway.address的服务处理的
external_address = "5.6.7.8:9000" 
# gateway 配置文件目录
conf_dir = "/root/.lamborage/gateway"
# 数据存储目录
data_dir = "/root/.lamborage/store"
#挖矿数据存储目录
mining_dir = "/root/.lamborage/store/mining"

[message]
# storage_name是machine-name；
storage_name = "machine-name" 
# MINER REST address
# miner节点启动的rest服务, 内网地址
miner_address = "5.6.7.8:26670" 
```

## 2. 启动storagenode

启动storagenode server和启动gateway server。
```
nohup ./storagenode server >> sserver.out 2>&1 &
nohup ./storagenode gateway >> sgateway.out 2>&1 &
```


# 挖矿

## 1. 配置

初始化lamb
```
./lamb init
```
初始化lamb 后会默认生成配置文件~/.lamborage/config/user.toml，修改user.toml

```
[broker]
# dht_gateway_addr为验证节点的dht服务 IP和端口；
dht_gateway_addr = "5.6.7.8:12000"  #需修改
# validator_addr为验证节点IP和端口
validator_addr = "5.6.7.8:13659"   #需修改
extra_key_file = " "

[gateway]
# local listen address
address = "0.0.0.0:9002"
# for login web UI
access_key = "accesskey"
secret_key = "secretkey"
```
同步所有订单的token

account-name 为发起买单账户名称
```
./lamb token sync [account-name]
```


## 2. 上传、查询文件

文本/图片/视频/音频/可执行文件/压缩包文件可正常上传。上传源文件路径为绝对路径。

- orderId为匹配单orderID;
- account-name为发起买单账户名称；

- 用内网上传文件使用下面两个参数provider_node_address为storagenode_server的IP和端口  ；
- - provider_storage_address为配置文件gateway.address
- - provider_node_address为配置文件的server.address


上传文件

```
LAMBDA_ORDER_ID=[orderId]./lamb cp [account-name] [srcPath] lamb:// --provider_node_address 1.2.3.4:13000 --provider_storage_address 1.2.3.4:9000
```
查询文件列表

```
LAMBDA_ORDER_ID=[orderId] ./lamb ls [account-name] lamb://
```


## 3. 矿工挖矿

矿工挖矿就是存储文件1G对应一个声明，声明有效期为1个月，每6s进行一次挑战声明，一次挑战10个声明，挑战到的声明矿工就会得到一笔收益。


1. 有效订单且有效存储文件 >= (1T) 的矿工有挖矿权利；
1. 矿工已存文件分别为1/3/5G可生成对应1/3/5个声明；


## 4. 挖矿收益
矿工收益 = 块增发总量 * （43% * 95% / 挖矿的矿工数量） + 块增发总量 * 43% * 5% * 矿工质押量在节点质押量的占比

` 比如块增发为100LAMB，节点质押666T，矿工质押1T，10个矿工。每个矿工为4.3%。
矿工得到的奖励为4.1LAMB `

