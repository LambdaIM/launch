

1个miner对应多个storagenode
# 存储业务架构图
![avatar](https://github.com/LambdaIM/launch/blob/master/arch_img/lamborage_arch.jpg)

# 配置miner节点

## 1. 下载安装包并解压

创建目录并进入 

```
mkdir -p ~/LambdaIM && cd ~/LambdaIM
```
下载安装包
```
wget https://github.com/LambdaIM/launch/releases/download/v0.4.0/lambda-storage-0.4.0-testnet.tar.gz
```
解压安装包
```
tar zxvf lambda-storage-0.4.0-testnet.tar.gz
```
进入解压后的目录
```
cd lambda-storage-0.4.0-testnet
```

## 2. 配置miner

```
./lambdacli config node tcp://47.93.196.236:26657

可选节点IP如下:
47.93.196.236
47.94.129.97
39.105.148.217

```

```
 ./lambdacli config chain-id lambda-chain-test4.0
```

```
./lambdacli config trust-node true
```
## 3. 添加账户
将[your-account-name]替换成您自定义的账户名称，需要设置您的账户密码，不用加中括号

```
./lambdacli keys add [your-account-name]
```
如果是钱包创建的账户导入，则通过钱包创建账户时候的助记词进行操作

```
./lambdacli keys add [your-account-name] --recover
```
输入命令后按照提示输入密码和助记词即可

## 4. 创建miner
质押到节点。
节点地址 可通过浏览器查找 http://testbrowser.lambda.im/#/ 或询问节点，
[your-account-name] 是您在第3步创建的账户名称
### 创建矿工
```
./lambdacli tx staking delegate lambdavaloper1prrcl9674j4aqrgrzmys5e28lkcxmntxuvjpcl 20000000utbb \
--from [your-account-name] --broadcast-mode block -y
可选节点地址：
lambdavaloper1prrcl9674j4aqrgrzmys5e28lkcxmntxuvjpcl
lambdavaloper1thj5fv8d0dsh3aealhpxm9mvgxjfh87suwuj2h
lambdavaloper1a83p8s9gs5hua09xn5ktmahepst3vzg9u2l20d
```

### 初始化矿工
```
./lambdacli tx market create-miner --from [your-account-name] --broadcast-mode block -y
```
### 启动矿工服务
```
./lambdacli miner-server --from [miner-name] --query-interval 5 --laddr tcp://0.0.0.0:26670 --gas 500000

如需在后台一直启动矿工服务，可进行如下操作步骤：
1. ./lambdacli miner-server --from [miner-name] --query-interval 5 --laddr tcp://0.0.0.0:26670 --gas 500000 >> miner.log 
2. 输入密码并回车后按Ctrl+Z
3. 紧接着输入bg（如按Ctrl+Z以后方括号中不是1，可输入bg %对应数值，例如：显示 [3]+  已停止  ，可输入bg %3）
4. 输入tail -f miner.log查看日志在更新中即表示miner-server在后台正常运行
```


## 5. 注册storagenode

创建存储节点

machine-name：大于3小于16个字符，支持英文大小写和数字。
初始化storagenode（`./storagenode init`）后执行`./storagenode info`查看dht-id、peer-id和pub-key。

```
./storagenode init
```
```
./storagenode info
运行结果：
storage name: machine1
  public key: 1624de64205ad2b4eca8c33922a8228a5217900e5725bf3013639118d1002b6a413971f9dc
     peer id: bdd4da2a3021d30e8f215dba64716cec02cdb8a7
      dht id: 5i6fXKQJoktPVmt9PAfZ18RN7DG6tghQN7SK7A3Bq4Rc
```
```
./lambdacli tx market create-machine --dht-id [dht-id] --name [machine-name] \
--peer-id [peer-id] --pub-key [pub-key] --from [your-miner-name] --broadcast-mode block -y
```



[storagenode配置启动参考](https://github.com/LambdaIM/launch/blob/master/%E6%B5%8B%E8%AF%95%E7%BD%910.4.0%20Storagenode%E6%8E%A5%E5%85%A5%E6%95%99%E7%A8%8B.md)

## 6. 矿工创建卖单

赔付比率rate为1的是普通卖单；赔付比率大于等于3的为优质卖单，优质卖单可指定卖单价格。  
设置指定storagenode的machine-name需要卖出的空间大小size；   
最小购买空间min-size不能小于1GB;  
最小购买时长min-buy-duration不能小于1month;  
最大购买时长max-buy-duration不能大于60month。

### 创建卖单

一台storagenode只允许存在一笔有可用空间的卖单

```
./lambdacli tx market create-sellorder --price 5000000ulamb  \
--rate [rate] \
--size [size]GB \
--market-name LambdaMarket --machine-name [machine-name] \
--min-size [min-size]GB \
--min-buy-duration [min-buy-duration]month \
--max-buy-duration [max-buy-duration]month \
--from [miner-name] --broadcast-mode block -y
```
### 查询卖单


```
查询账户地址：
./lambdacli keys show [miner-name] --address
根据账户地址查看矿工卖单：
./lambdacli query market miner-sellorders [address] [page] [limit] 

例如：
查看账户名为miner2的地址：./lambdacli keys show miner2 --address
返回结果：lambda1k6rxrmly7hz0ewh7gth2dj48mv3xs9yz8ffauw

./lambdacli query market miner-sellorders lambda1k6rxrmly7hz0ewh7gth2dj48mv3xs9yz8ffauw 1 10
返回结果：
SellOrder
  OrderId:            54F82FBD979BE150C8B3246D82DDF60F043129EE  //卖单ID，取消卖单或创建优质买单时需要用到此ID
  Address:            lambdamineroper1k6rxrmly7hz0ewh7gth2dj48mv3xs9yznx96fn
  Price:              5000000
  Rate:               3.000000000000000000  //rate大于等于3，则该卖单为优质卖单
  Amount:
  SellSize:           400
  UnUseSize:          0
  Status:             1
  CreateTime:         2019-11-04 12:02:24.379880755 +0000 UTC
  CancelTimeDuration: 1h0m0s
  MarketAddress:      lambdamarketoper1thj5fv8d0dsh3aealhpxm9mvgxjfh87srk3887
  MachineName:        machine1
  MinBuySize:         1
  MinDuration:        720h0m0s
  MaxDuration:        43200h0m0s
```

### 取消卖单

根据SellOrderID取消卖单
```
./lambdacli tx market cancel-order [orderId] --from [miner-name] --broadcast-mode block -y
```


## 7. 创建买单
矿工不能买自己的卖单，只能换其他账户来挂买单。

创建优质买单需要指定对应优质卖单SellOrderID。

account-name为当前账户的名称；
duration为购买时长；
size为需要购买的空间，不小于对应卖单指定的最小购买空间。

### 创建普通买单

```
 ./lambdacli tx market create-buyorder --from [account-name] \
 --duration [buy-duration]month --market-name LambdaMarket \
 --size [size]GB --broadcast-mode block -y
```

### 创建优质买单

```
./lambdacli tx market create-buyorder --sellorder-id [orderId] \
--from [your-account-name] --duration [buy-duration]month \
--market-name LambdaMarket --size [size]GB --broadcast-mode block -y
```
### 查询匹配订单

```
查询账户地址：
./lambdacli keys show [account-name] --address
根据账户地址查看匹配订单：
./lambdacli query market matchorders [address] [page] [limit]

例如：
./lambdacli keys show buyaccount --address
返回结果：lambda1thj5fv8d0dsh3aealhpxm9mvgxjfh87s224esr
./lambdacli query market matchorders lambda1thj5fv8d0dsh3aealhpxm9mvgxjfh87s224esr 1 10
返回结果：
MatchOrder
  OrderId:               05F09566BA4397BC9EB378EC202676D3FFCAF660   //匹配订单ID，上传文件时需要用到该ID
  AskAddress:            lambdamineroper1k6rxrmly7hz0ewh7gth2dj48mv3xs9yznx96fn
  BuyAddress:            lambda1thj5fv8d0dsh3aealhpxm9mvgxjfh87s224esr
  SellOrderId:           58941CFFEEA859AED51172F0F9DF3E77293D2E12
  BuyOrderId:            F3B5BDE351253E1D47DA7CEB24C0E4BAB5BDA808
  Price:                 5000000
  Size:                  20
  CreateTime:            2019-11-01 13:20:58.296399278 +0000 UTC
  EndTime:               2019-12-01 13:20:58.296399278 +0000 UTC
  CancelTimeDuration:    1h0m0s
  WithDrawTime:          2019-11-01 13:20:58.296399278 +0000 UTC
  Status:                0
  MarketAddress:         lambdamarketoper1thj5fv8d0dsh3aealhpxm9mvgxjfh87srk3887
  MachineName:           machine1
  UserPay:               100000000ulamb
  MinerPay:              100000000ulamb
  PubKey:                PubKeyEd25519{5AD2B4ECA8C33922A8228A5217900E5725BF3013639118D1002B6A413971F9DC}
  PeerId:                bdd4da2a3021d30e8f215dba64716cec02cdb8a7
  DhtId:                 5i6fXKQJoktPVmt9PAfZ18RN7DG6tghQN7SK7A3Bq4Rc
```

## 8. 挖矿及提取订单收益
[如何挖矿及挖矿收益计算](https://github.com/LambdaIM/launch/blob/master/%E6%B5%8B%E8%AF%95%E7%BD%910.4.0%20Storagenode%E6%8E%A5%E5%85%A5%E6%95%99%E7%A8%8B.md#%E6%8C%96%E7%9F%BF)  
[按匹配订单提取卖单收益](./docs/lambdacli/tx/market/withdraw-miner.md)  
[按存储节点提取卖单收益](./docs/lambdacli/tx/market/miner-withdraw-machine.md)

